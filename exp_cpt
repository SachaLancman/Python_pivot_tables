import pandas as pd
import sqlalchemy
import win32com.client as win32

# Set up the database connection
server = "medissys.bi.dts.corp.local"
port = 1435
database = "med_bi"
driver = "ODBC Driver 13 for SQL Server"
connection_string = f"mssql+pyodbc://{server}:{port}/{database}?trusted_connection=yes&driver={driver}"
engine = sqlalchemy.create_engine(connection_string)

# Get Data From Med_bi
sql_query = "SELECT id_counter, date_expo, [sale_due_amt $], [purchase_due_amt $],[sale_due_amt $] - [purchase_due_amt $] AS [NET], [Pay_risk $ (pty-8d)],[pay_risk_unsecured (pty-8d)] " \
            "FROM MED_BI.dbo.credit_phy_cpt WHERE date_expo >= DATEADD(year, -1, GETDATE()) AND date_expo <= CAST (GETDATE() AS DATE)"
df = pd.read_sql(sql_query, engine)

sql_query_2 = "SELECT id_counter, Name_full FROM MED_BI.dbo.COUNTERPARTY"
df_2 = pd.read_sql(sql_query_2, engine)

df_3 = pd.merge(df, df_2, on='id_counter', how="inner")

df_3.to_excel('exposure_cpt.xlsx', index=False)

# Create the Excel application object
xlApp = win32.Dispatch('Excel.Application')
xlApp.Visible = True

# Open the workbook
wb = xlApp.Workbooks.Open(r'C:\Users\SLANCM\PycharmProjects\python_Project_1\exposure_cpt.xlsx')
ws_data = wb.Worksheets(1)

# Convert the table to a real Excel table
table_range = ws_data.Range(ws_data.Cells(1, 1), ws_data.Cells(df_3.shape[0] + 1, df_3.shape[1]))
table = ws_data.ListObjects.Add(1, table_range, 1, 1)

# Change the style of the table
table.TableStyle = "TableStyleMedium15"

# Format the currency fields in the first sheet
currency_fields = ['purchase_due_amt $', 'sale_due_amt $', 'NET', 'Pay_risk $ (pty-8d)', 'pay_risk_unsecured (pty-8d)']
for field in currency_fields:
    column_index = df_3.columns.get_loc(field) + 1  # Get the column index (1-based)
    ws_data.Columns(column_index).NumberFormat = "_($* #,##0.00_);_($* (#,##0.00);_($* -??_);_(@_)"

# Auto-fit the columns in the first sheet
ws_data.UsedRange.Columns.AutoFit()

# Clear pivot tables on the Report tab
def clear_pts(ws):
    for pt in ws.PivotTables():
        pt.TableRange2.Clear()

# Create the first pivot table
ws_report1 = wb.Worksheets.Add()
clear_pts(ws_report1)
pt_cache1 = wb.PivotCaches().Create(1, ws_data.Range("A1").CurrentRegion)
pt1 = pt_cache1.CreatePivotTable(ws_report1.Range("B3"), "PivotTable1")

# Insert pivot table field settings for the first pivot table
def insert_pt_field_set1(pt):
    field_filters = {}
    field_filters['date_expo'] = pt.PivotFields("date_expo")

    field_rows = {}
    field_rows['Name_full'] = pt.PivotFields("Name_full")

    field_values = {}
    field_values['pay_risk_unsecured (pty-8d)'] = pt.PivotFields("pay_risk_unsecured (pty-8d)")
    field_values['pay_risk_unsecured (pty-8d)'] = pt.PivotFields("pay_risk_unsecured (pty-8d)")

    # Insert filter fields
    field_filters['date_expo'].Orientation = 3  # xlPageField
    field_filters['date_expo'].Position = 1

    # Insert row field
    field_rows['Name_full'].Orientation = 1
    field_rows['Name_full'].Position = 1

    # Insert values field
    field_values['pay_risk_unsecured (pty-8d)'].Orientation = 4
    field_values['pay_risk_unsecured (pty-8d)'].Function = -4136
    field_values['pay_risk_unsecured (pty-8d)'].NumberFormat = "_($* #,##0.00_);_($* (#,##0.00);_($* -??_);_(@_)"

    field_values['pay_risk_unsecured (pty-8d)'].Orientation = 4
    field_values['pay_risk_unsecured (pty-8d)'].Function = -4139
    field_values['pay_risk_unsecured (pty-8d)'].NumberFormat = "_($* #,##0.00_);_($* (#,##0.00);_($* -??_);_(@_)"

insert_pt_field_set1(pt1)

# Change pivot table style for the first pivot table
pt1.TableStyle2 = "PivotStyleDark8"

# Adjust column widths for the first pivot table
ws_report1.Columns("D:E").ColumnWidth = 30

# Rename the sheets
ws_data.Name = 'table'
ws_report1.name = 'Min&Max cpt'

# Save the modified workbook
wb.Save()
